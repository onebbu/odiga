<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.odiga.mytrip.travel.dao.PlaceDAO">
    <resultMap type="TravelListVO" id="PlaceList">
        <result column="contentid" property="contentid"/>
        <result column="title" property="title"/>
        <result column="addr1" property="addr1" />
        <result column="firstimage" property="firstimage"/>
        <result column="cat3" property="cat3"/>
        <result column="areacode" property="areacode"/>
    </resultMap>

    <!-- 여행지 지역별 리스트 가져오기 -->
    <select id="getPlaceList" resultMap="PlaceList" parameterType="String">
        SELECT *
        FROM (
            SELECT contentid, title, addr1, firstimage, cat3, areacode
            FROM travellist
            WHERE AREACODE = #{areacode}
            ORDER BY ${order}
        ) WHERE ROWNUM <![CDATA[<= ]]> #{displayCount}
    </select>

    <!-- 여행지별 리뷰 평균 별점 조회 -->
    <select id="getPlaceRate" resultType="java.util.Map" parameterType="String">
        SELECT NVL(ROUND(AVG(REVIEWGRADE)),0) AS "averageRate", count(*) as "cntRating"
        FROM TRAVELREVIEW
        WHERE contentid = #{contentID}
    </select>

    <!-- 여행지 코스 저장 -->
    <insert id="SaveResultList" parameterType="java.util.Map">
        Insert into resultlist
        (RESULTID, COURSENO, COURSEDAY, TRAVELNUM, CONTENTID, NICKNAME, courseyn, WRITEYN, COURSEPW, COURSETITLE)
        VALUES (#{RESULTID}, #{COURSENO}, #{COURSEDAY}, #{TRAVELNUM}, #{CONTENTID},
                #{NICKNAME}, 'y', 'n', #{COURSEPW}, #{title})
    </insert>

    <select id="getMaxNum" parameterType="String">
        SELECT NVL(TO_NUMBER(MAX(SUBSTR(COURSENO, INSTR(COURSENO, '_', -1) +1))), 0) AS MAX_NUMBER
        FROM resultlist
        WHERE COURSENO LIKE #{nickname} || '_%'
    </select>

</mapper>